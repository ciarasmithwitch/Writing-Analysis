<!DOCTYPE html>
<html>
<head>
  <title>Writing Analyzer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea, input { width: 100%; margin: 10px 0; }
    textarea { height: 200px; }
    button { padding: 10px 15px; font-size: 16px; margin-top: 10px; }
    .result { margin-top: 15px; padding: 10px; border-radius: 6px; }
    .green { background: #d4edda; }
    .yellow { background: #fff3cd; }
    .red { background: #f8d7da; }
  </style>
</head>
<body>
  <h1>Writing Analyzer</h1>
  <label for="names">Character names (comma separated):</label>
  <input type="text" id="names" placeholder="e.g. Connor, Indy, Rosy">
  
  <p>We measure worldbuilding as the percentage of words that are not pronouns (e.g. she/he/I). High percentages may indicate description or exposition. It's a proxy metric.</p>
  
  <label for="text">Paste your text:</label>
  <textarea id="text" maxlength="10000"></textarea><br>
  <button onclick="analyze()">Analyze</button>
  
  <div id="output"></div>

  <p>If you get moderate sentence or too many long sentence results, you may want to edit to have more sentence length variety. If you get a "heavy" result for some categories, you may want to reduce how much you have of that and work towards more balance. If you get "quite a lot" results, it's something to look out for and maybe edit some to get more balanced, depending on your goals. If you get "balanced" results, great job! You're avoiding most first page problems.</p>

<!-- Load Compromise first -->
<script src="https://unpkg.com/compromise@latest/builds/compromise.min.js"></script>

<script>
function analyzeTense(text) {
  if (typeof nlp !== "function") return `<div class="red result">Compromise library not loaded.</div>`;

  const doc = nlp(text);
  const verbs = doc.verbs();
  const presentCount = verbs.filter(v => v.isPresentTense().out('array').length > 0).length;
  const pastCount = verbs.filter(v => v.isPastTense().out('array').length > 0).length;
  const futureCount = verbs.filter(v => v.isFutureTense().out('array').length > 0).length;
  const totalVerbs = verbs.length;

  if(totalVerbs === 0) return `<div class="green result">No verbs detected for tense analysis.</div>`;

  const tensePercentages = {
    Present: Math.round((presentCount / totalVerbs) * 100),
    Past: Math.round((pastCount / totalVerbs) * 100),
    Future: Math.round((futureCount / totalVerbs) * 100)
  };

  let output = '';
  for(const [tense, pct] of Object.entries(tensePercentages)) {
    let color = pct <= 60 ? "green" : pct <= 80 ? "yellow" : "red";
    output += `<div class="${color} result">${tense} tense: ${pct}% (${tense === "Present" ? presentCount : tense === "Past" ? pastCount : futureCount} verbs)</div>`;
  }

  const dominantTense = Object.entries(tensePercentages).sort((a,b)=>b[1]-a[1])[0];
  if(dominantTense[1] > 80) {
    output += `<div class="red result">Warning: Mostly ${dominantTense[0]} tense detected. Consider varying tenses for clarity.</div>`;
  }

  return output;
}

function analyze() {
  const text = document.getElementById("text").value;
  const namesInput = document.getElementById("names").value || "";
  const totalWords = text.trim().split(/\s+/).filter(Boolean).length;
  let output = '';

  // ---------- Sentence Length ----------
  const sentences = text.split(/[.!?]/).filter(s => s.trim().length > 0);
  const longSentences = sentences.filter(s => s.split(" ").length > 20);
  const longPercent = sentences.length > 0 ? Math.round((longSentences.length / sentences.length) * 100) : 0;
  if(longPercent <= 25) output += `<div class="green result">Great sentence length variety: ${longPercent}% long sentences</div>`;
  else if(longPercent <= 60) output += `<div class="yellow result">Moderate long sentences: ${longPercent}%. Consider breaking some up.</div>`;
  else output += `<div class="red result">Too many long sentences: ${longPercent}%</div>`;

  // ---------- Telling Words ----------
  const tellingWords = [ /* ...all your telling words here... */ ];
  let tellingMatches = tellingWords.filter(word => new RegExp(`\\b${word}\\b`, 'i').test(text));
  let tellingWordCount = 0;
  tellingMatches.forEach(word => {
    const matches = text.match(new RegExp("\\b" + word + "\\b", "gi"));
    if(matches) tellingWordCount += matches.length;
  });
  let tellingPercent = totalWords > 0 ? Math.round((tellingWordCount / totalWords) * 100) : 0;
  let tellingColor = tellingPercent <=5 ? "green" : tellingPercent <=15 ? "yellow" : "red";
  let tellingDescriptor = tellingPercent <=5 ? "Low – good balance" : tellingPercent <=15 ? "Moderate – consider reviewing" : "High – heavy on telling words";
  output += `<div class="${tellingColor} result">Telling words: ${tellingPercent}% (${tellingMatches.join(", ")}) – ${tellingDescriptor}</div>`;

  // ---------- Filter Words ----------
  const filterWords = [ /* ...all your filter words here... */ ];
  let filterMatches = filterWords.filter(word => new RegExp(`\\b${word}\\b`, 'i').test(text));
  let filterWordCount = 0;
  filterMatches.forEach(word => {
    const matches = text.match(new RegExp("\\b" + word + "\\b", "gi"));
    if(matches) filterWordCount += matches.length;
  });
  let filterPercent = totalWords > 0 ? Math.round((filterWordCount / totalWords) * 100) : 0;
  let filterColor = filterPercent <=5 ? "green" : filterPercent <=15 ? "yellow" : "red";
  let filterDescriptor = filterPercent <=5 ? "Low – good balance" : filterPercent <=15 ? "Moderate – consider reviewing" : "High – heavy on filter words";
  output += `<div class="${filterColor} result">Filter words: ${filterPercent}% (${filterMatches.join(", ")}) – ${filterDescriptor}</div>`;

  // ---------- Dialogue ----------
  const dialogueMatches = text.match(/["“”']([^"“”']*)["“”']/g) || [];
  const dialogueWords = dialogueMatches.join(" ").split(/\s+/).filter(Boolean).length;
  const dialoguePercent = totalWords > 0 ? Math.round((dialogueWords / totalWords) * 100) : 0;
  if(dialoguePercent>50) output += `<div class="red result">Dialogue heavy: ${dialoguePercent}% of words</div>`;
  else if(dialoguePercent>30) output += `<div class="yellow result">Quite a lot of dialogue: ${dialoguePercent}%</div>`;
  else output += `<div class="green result">Balanced dialogue: ${dialoguePercent}%</div>`;

  // ---------- Passive Voice ----------
  const passiveWords = ["was","is","am","are","be","being","been","has","were","began to","begin to","starting to","started to"];
  let passiveCount=0;
  passiveWords.forEach(word => {
    const matches = text.match(new RegExp("\\b"+word+"\\b","gi"));
    if(matches) passiveCount+=matches.length;
  });
  const passivePercent = totalWords>0?Math.round((passiveCount/totalWords)*100):0;
  if(passivePercent>50) output += `<div class="red result">Passive heavy: ${passivePercent}%</div>`;
  else if(passivePercent>30) output += `<div class="yellow result">Quite a lot of passive voice: ${passivePercent}%</div>`;
  else output += `<div class="green result">Balanced between active and passive: ${passivePercent}%</div>`;

  // ---------- Character vs Worldbuilding ----------
  const pronouns = ["she","her","he","him","i","me","my","we","us","our","they","them","their"];
  const userNames = namesInput.toLowerCase().split(",").map(n=>n.trim()).filter(Boolean);
  const characterWords = [...pronouns, ...userNames];
  const wordsArray = text.toLowerCase().split(/\s+/).filter(Boolean);
  const windowSize=20, step=5;
  let characterBlocks=0, totalBlocks=0;
  for(let i=0;i<wordsArray.length;i+=step){
    const block = wordsArray.slice(i,i+windowSize);
    if(block.length===0) continue;
    totalBlocks++;
    if(block.some(word=>characterWords.includes(word))) characterBlocks++;
  }
  const characterPercent = totalBlocks>0?Math.round((characterBlocks/totalBlocks)*100):0;
  const worldPercent = 100-characterPercent;
  if(worldPercent>70) output += `<div class="red result">Heavy on worldbuilding: ${worldPercent}% lacks character focus</div>`;
  else if(worldPercent>50) output += `<div class="yellow result">Quite a bit of worldbuilding: ${worldPercent}% lacks character focus</div>`;
  else output += `<div class="green result">Balanced: ${characterPercent}% character-focused, ${worldPercent}% world-focused</div>`;

  // ---------- Overused Words ----------
  const wordsArrayLower = text.toLowerCase().match(/\b\w+\b/g)||[];
  const stopWords = ["the","and","a","an","of","in","to","with","for","on","at","by","is","it","as","that","this","from","was","were","be","are","i","you","he","she","they","we","him","her","them"];
  const wordCounts = {};
  wordsArrayLower.forEach(word=>{
    if(!stopWords.includes(word)){
      const matches = text.match(new RegExp("\\b"+word+"\\b","gi"));
      if(matches) wordCounts[word]=(wordCounts[word]||0)+matches.length;
    }
  });
  const overusedThreshold = Math.max(5, Math.round(totalWords*0.01));
  const overused = Object.entries(wordCounts).filter(([w,c])=>c>=overusedThreshold).sort((a,b)=>b[1]-a[1]);
  if(overused.length>0){
    let overusedOutput="";
    overused.forEach(([w,c])=>overusedOutput+=`${w} (${c}x), `);
    overusedOutput = overusedOutput.slice(0,-2);
    output += `<p><strong>Overused Words:</strong></p><div class="red result">Warning: Overused words detected: ${overusedOutput}</div>`;
  } else output += `<p><strong>Overused Words:</strong></p><div class="green result">No major overused words detected.</div>`;

  // ---------- Tense Analysis ----------
  output += `<p><strong>Tense Analysis:</strong></p>`;
  output += analyzeTense(text);

  document.getElementById("output").innerHTML = output;
}
</script>
</body>
</html>




